<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shorturl.mapper.VisitLogMapper">

    <resultMap id="BaseResultMap" type="com.shorturl.entity.VisitLog">
        <id column="id" property="id"/>
        <result column="short_code" property="shortCode"/>
        <result column="visit_time" property="visitTime"/>
        <result column="ip_address" property="ipAddress"/>
        <result column="country" property="country"/>
        <result column="province" property="province"/>
        <result column="city" property="city"/>
        <result column="isp" property="isp"/>
        <result column="user_agent" property="userAgent"/>
        <result column="browser" property="browser"/>
        <result column="browser_version" property="browserVersion"/>
        <result column="os" property="os"/>
        <result column="os_version" property="osVersion"/>
        <result column="device_type" property="deviceType"/>
        <result column="device_brand" property="deviceBrand"/>
        <result column="device_model" property="deviceModel"/>
        <result column="referer" property="referer"/>
    </resultMap>

    <insert id="insert" parameterType="com.shorturl.entity.VisitLog">
        INSERT INTO visit_log (short_code, visit_time, ip_address, country, province, city, isp, 
                               user_agent, browser, browser_version, os, os_version, 
                               device_type, device_brand, device_model, referer)
        VALUES (#{shortCode}, #{visitTime}, #{ipAddress}, #{country}, #{province}, #{city}, #{isp},
                #{userAgent}, #{browser}, #{browserVersion}, #{os}, #{osVersion},
                #{deviceType}, #{deviceBrand}, #{deviceModel}, #{referer})
    </insert>

    <select id="selectRecentVisits" resultMap="BaseResultMap">
        SELECT * FROM visit_log
        WHERE short_code = #{shortCode}
        ORDER BY visit_time DESC
        LIMIT #{limit}
    </select>

    <select id="selectDailyStats" resultType="map">
        SELECT DATE_FORMAT(visit_time, '%Y-%m-%d') as date,
               COUNT(*) as count
        FROM visit_log
        WHERE short_code = #{shortCode}
          AND visit_time >= DATE_SUB(NOW(), INTERVAL #{days} DAY)
        GROUP BY DATE_FORMAT(visit_time, '%Y-%m-%d')
        ORDER BY date DESC
    </select>

    <select id="selectByUserIdWithPage" resultMap="BaseResultMap">
        SELECT vl.*
        FROM visit_log vl
        INNER JOIN url_mapping um ON vl.short_code = um.short_code
        WHERE um.user_id = #{userId}
        <if test="shortCode != null and shortCode != ''">
            AND vl.short_code = #{shortCode}
        </if>
        ORDER BY vl.visit_time DESC
        LIMIT #{offset}, #{size}
    </select>

    <select id="countByUserId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM visit_log vl
        INNER JOIN url_mapping um ON vl.short_code = um.short_code
        WHERE um.user_id = #{userId}
        <if test="shortCode != null and shortCode != ''">
            AND vl.short_code = #{shortCode}
        </if>
    </select>

    <select id="selectLocationStats" resultType="map">
        SELECT 
            COALESCE(country, '未知') as country,
            COALESCE(province, '未知') as province,
            COALESCE(city, '未知') as city,
            COUNT(*) as count
        FROM visit_log
        WHERE short_code = #{shortCode}
        GROUP BY country, province, city
        ORDER BY count DESC
        LIMIT 20
    </select>

    <select id="selectDeviceTypeStats" resultType="map">
        SELECT 
            COALESCE(device_type, '未知') as deviceType,
            COUNT(*) as count
        FROM visit_log
        WHERE short_code = #{shortCode}
        GROUP BY device_type
        ORDER BY count DESC
    </select>

    <select id="selectBrowserStats" resultType="map">
        SELECT 
            COALESCE(browser, '未知') as browser,
            COUNT(*) as count
        FROM visit_log
        WHERE short_code = #{shortCode}
        GROUP BY browser
        ORDER BY count DESC
        LIMIT 10
    </select>

    <select id="selectOsStats" resultType="map">
        SELECT 
            COALESCE(os, '未知') as os,
            COUNT(*) as count
        FROM visit_log
        WHERE short_code = #{shortCode}
        GROUP BY os
        ORDER BY count DESC
        LIMIT 10
    </select>

    <!-- 全局统计查询 -->
    <select id="countTotalVisits" resultType="java.lang.Long">
        SELECT COUNT(*) FROM visit_log
    </select>

    <select id="countTodayVisits" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM visit_log
        WHERE DATE(visit_time) = CURDATE()
    </select>

    <select id="countYesterdayVisits" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM visit_log
        WHERE DATE(visit_time) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
    </select>

    <select id="selectDailyTrends" resultType="map">
        SELECT 
            DATE_FORMAT(visit_time, '%Y-%m-%d') as date,
            COUNT(*) as count
        FROM visit_log
        WHERE visit_time >= DATE_SUB(NOW(), INTERVAL #{days} DAY)
        GROUP BY DATE_FORMAT(visit_time, '%Y-%m-%d')
        ORDER BY date ASC
    </select>

    <select id="selectLocationStats" resultType="map">
        SELECT 
            CONCAT(
                COALESCE(province, '未知'),
                IF(city IS NOT NULL AND city != '', CONCAT(' ', city), '')
            ) as location,
            COUNT(*) as count
        FROM visit_log
        GROUP BY province, city
        ORDER BY count DESC
        LIMIT #{limit}
    </select>

    <select id="selectDeviceStats" resultType="map">
        SELECT 
            COALESCE(device_type, '未知') as deviceType,
            COUNT(*) as count
        FROM visit_log
        GROUP BY device_type
        ORDER BY count DESC
    </select>

    <select id="selectBrowserStats" resultType="map">
        SELECT 
            COALESCE(browser, '未知') as browser,
            COUNT(*) as count
        FROM visit_log
        GROUP BY browser
        ORDER BY count DESC
        LIMIT #{limit}
    </select>

    <select id="selectOsStats" resultType="map">
        SELECT 
            COALESCE(os, '未知') as os,
            COUNT(*) as count
        FROM visit_log
        GROUP BY os
        ORDER BY count DESC
        LIMIT #{limit}
    </select>

    <select id="selectTopUrls" resultType="map">
        SELECT 
            um.short_code as shortCode,
            um.original_url as originalUrl,
            COUNT(vl.id) as visitCount
        FROM url_mapping um
        LEFT JOIN visit_log vl ON um.short_code = vl.short_code
        GROUP BY um.short_code, um.original_url
        ORDER BY visitCount DESC
        LIMIT #{limit}
    </select>

</mapper>

